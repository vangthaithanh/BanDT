@model WebDienThoai.Models.ViewModels.CreatePhieuNhapVM
@{
    ViewBag.Title = "Tạo phiếu nhập";
    Layout = "~/Views/Shared/_LayoutQT.cshtml";
}

<div class="bg-white p-4 rounded-3 shadow-sm">
    <div class="d-flex flex-column " style="min-height: 80vh;">
        <h2>Tạo phiếu nhập</h2>

        @using (Html.BeginForm("TaoPhieuNhap", "QuanLyKho", FormMethod.Post))
        {
            @Html.AntiForgeryToken()
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })

            <div class="row" style="margin-bottom:10px;">
                <div class="col-md-4">
                    <label>Kho</label>
                    <select class="form-control" name="MAKHO">
                        <option value="">-- Chọn kho --</option>
                        @foreach (var k in Model.KhoList)
                        {
                            <option value="@k.MAKHO" @(k.MAKHO == Model.MAKHO ? "selected" : "")>
                                @k.MAKHO - @k.TENKHO
                            </option>
                        }
                    </select>
                    @Html.ValidationMessage("MAKHO", "", new { @class = "text-danger" })
                </div>

                <div class="col-md-4">
                    <label>Nhà cung cấp</label>
                    <input class="form-control" name="NHACUNGCAP" value="@Model.NHACUNGCAP" />
                    @Html.ValidationMessage("NHACUNGCAP", "", new { @class = "text-danger" })
                </div>

                <div class="col-md-4">
                    <label>Ngày nhập</label>
                    <input class="form-control" type="datetime-local" name="NGAYNHAP"
                           value="@(Model.NGAYNHAP.HasValue ? Model.NGAYNHAP.Value.ToString("yyyy-MM-ddTHH:mm") : "")" />
                </div>
            </div>

            <h4>Chi tiết sản phẩm</h4>

            <table class="table table-bordered" id="tblItems">
                <thead>
                    <tr>
                        <th style="width:40%">MASP</th>
                        <th style="width:20%" class="text-right">Số lượng</th>
                        <th style="width:20%" class="text-right">Giá nhập</th>
                        <th style="width:20%"></th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Items.Count; i++)
                    {
                        <tr>
                            <td>
                                <input class="form-control" name="Items[@i].MASP" value="@Model.Items[i].MASP" />
                                @Html.ValidationMessage($"Items[{i}].MASP", "", new { @class = "text-danger" })
                            </td>
                            <td>
                                <input class="form-control text-right" type="number" min="1" name="Items[@i].SOLUONG" value="@Model.Items[i].SOLUONG" />
                                @Html.ValidationMessage($"Items[{i}].SOLUONG", "", new { @class = "text-danger" })
                            </td>
                            <td>
                                <input class="form-control text-right" type="number" min="1" step="1" name="Items[@i].GIANHAP" value="@Model.Items[i].GIANHAP" />
                                @Html.ValidationMessage($"Items[{i}].GIANHAP", "", new { @class = "text-danger" })
                            </td>
                            <td class="text-right">
                                <button type="button" class="btn btn-xs btn-danger" onclick="removeRow(this)">Xoá</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <button type="button" class="btn btn-default" onclick="addRow()">+ Thêm dòng</button>

            <div class="text-right" style="margin-top:10px;">
                @Html.ActionLink("Huỷ", "Index", null, new { @class = "btn btn-default" })
                <button class="btn btn-primary" type="submit">Lưu phiếu nhập</button>
            </div>
        }

        <script>
            function addRow() {
                var tbody = document.querySelector("#tblItems tbody");
                var i = tbody.querySelectorAll("tr").length;

                var tr = document.createElement("tr");
                tr.innerHTML =
                    '<td><input class="form-control" name="Items[' + i + '].MASP" value="" /></td>' +
                    '<td><input class="form-control text-right" type="number" min="1" name="Items[' + i + '].SOLUONG" value="1" /></td>' +
                    '<td><input class="form-control text-right" type="number" min="1" step="1" name="Items[' + i + '].GIANHAP" value="1" /></td>' +
                    '<td class="text-right"><button type="button" class="btn btn-xs btn-danger" onclick="removeRow(this)">Xoá</button></td>';

                tbody.appendChild(tr);
            }

            function removeRow(btn) {
                var tbody = document.querySelector("#tblItems tbody");
                if (tbody.querySelectorAll("tr").length <= 1) return;
                btn.closest("tr").remove();
            }
        </script>
    </div>
</div> 